# Phase 2: PostgreSQL 和 Redis 配置 (非 Root 用户)

## 数据库服务配置

**配置状态**: ✅ 已验证，PostgreSQL 和 Redis 配置语法正确，存储问题已修复，已成功部署到集群

### PostgreSQL 配置
- **服务名称**: `postgres-service`
- **端口**: `5432`
- **数据库**: `chatapp`
- **用户**: `postgres`
- **密码**: `postgres`
- **存储**: 10Gi 本地持久化存储

### Redis 配置
- **服务名称**: `redis-service`
- **端口**: `6379`
- **持久化**: 启用 AOF (Append Only File)
- **存储**: 5Gi 本地持久化存储

## 存储配置 (新增)

### 本地存储类
```yaml
# k8s/base/storage/storageclass.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Retain
```

### 持久化卷
```yaml
# k8s/base/storage/persistent-volumes.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: postgres-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  local:
    path: /home/parallels/data/postgres
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - ubuntu-linux-2404
```

## 部署命令

### 1. 创建数据目录
```bash
# 创建本地数据目录 (普通用户权限)
mkdir -p /home/parallels/data/postgres /home/parallels/data/redis
```

### 2. 部署存储
```bash
# 部署存储类和持久化卷
kubectl apply -k k8s/base/storage/
```

### 3. 部署数据库服务
```bash
# 部署 PostgreSQL 和 Redis
kubectl apply -k k8s/base/db/
```

### 4. 验证部署
```bash
# 查看数据库 Pod 状态
kubectl get pods -l app=postgres
kubectl get pods -l app=redis

# 查看服务状态
kubectl get svc postgres-service
kubectl get svc redis-service

# 查看存储状态
kubectl get pv
kubectl get pvc
```

## 配置验证

```bash
# 验证存储配置
kubectl apply --dry-run=client -k k8s/base/storage/

# 验证数据库配置
kubectl apply --dry-run=client -k k8s/base/db/
```

## 数据库连接测试

```bash
# 测试 PostgreSQL 连接
kubectl run postgres-client --rm --restart=Never --image=postgres:15 -- psql -h postgres-service -U postgres -d chatapp -c "SELECT version();"

# 测试 Redis 连接
kubectl run redis-client --rm --restart=Never --image=redis:7-alpine -- redis-cli -h redis-service ping
```

## 数据持久化

两个数据库都配置了本地持久化存储：
- PostgreSQL 数据存储在 `/home/parallels/data/postgres`
- Redis 数据存储在 `/home/parallels/data/redis`
- 使用 StatefulSet 确保数据持久性和有序部署
- 使用本地存储类避免需要管理员权限

## 部署状态验证

### 检查数据库部署状态
```bash
# 查看数据库 Pod 状态
kubectl get pods -l app=postgres
kubectl get pods -l app=redis

# 查看数据库服务状态
kubectl get svc postgres-service
kubectl get svc redis-service

# 查看 StatefulSet 状态
kubectl get statefulset postgres
kubectl get statefulset redis
```

### 验证存储绑定
```bash
# 查看持久化卷状态
kubectl get pv

# 查看持久化卷声明状态
kubectl get pvc

# 查看存储类
kubectl get storageclass
```

### 当前部署状态
- ✅ PostgreSQL StatefulSet 已成功部署并运行
- ✅ Redis StatefulSet 已成功部署并运行
- ✅ 数据库服务已创建并可访问
- ✅ 本地持久化存储已配置并绑定
- ✅ 所有存储资源使用普通用户权限创建

## 故障排除

### 常见问题
1. **Pod 启动失败**: 检查存储类配置和持久化卷状态
2. **PVC 处于 Pending 状态**: 确认存储类已创建且持久化卷可用
3. **数据目录权限问题**: 确保数据目录在用户主目录下创建

### 调试命令
```bash
# 查看 Pod 详情
kubectl describe pod postgres-0
kubectl describe pod redis-0

# 查看 PVC 详情
kubectl describe pvc postgres-storage-postgres-0
kubectl describe pvc redis-storage-redis-0

# 查看存储类详情
kubectl describe storageclass local-storage
```

## 清理部署

```bash
# 删除数据库服务
kubectl delete -k k8s/base/db/

# 删除存储资源
kubectl delete -k k8s/base/storage/

# 清理数据目录 (可选)
rm -rf /home/parallels/data/postgres /home/parallels/data/redis
```
