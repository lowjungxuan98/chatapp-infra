# Phase 6: 完整部署指南

## 部署概述

**部署状态**: ✅ 完整部署流程已测试，所有组件正常运行

本指南将带您完成整个 Kubernetes 基础设施的部署，包括所有 5 个阶段的组件。

## 前置要求

### 系统要求
- **操作系统**: macOS, Linux, Windows
- **Docker Desktop**: 已安装并启用 Kubernetes
- **kubectl**: 已安装并配置
- **Kustomize**: 已安装（通常随 kubectl 一起安装）

### 验证环境
```bash
# 检查 kubectl 版本
kubectl version --client

# 检查 Kustomize 版本
kubectl kustomize version

# 检查 Kubernetes 集群状态
kubectl cluster-info

# 检查节点状态
kubectl get nodes
```

## 完整部署流程

### 方法一：一键部署（推荐）

```bash
# 1. 进入项目目录
cd /path/to/infra

# 2. 一键部署所有组件
kubectl apply -k k8s/overlays/docker-desktop/

# 3. 等待所有 Pod 启动
kubectl get pods -w

# 4. 验证部署状态
kubectl get all
```

### 方法二：分阶段部署

#### 阶段 1: Secret 配置
```bash
# 部署 Secret
kubectl apply -k k8s/base/secrets/

# 验证
kubectl get secret app-secrets
kubectl describe secret app-secrets
```

#### 阶段 2: 数据库服务
```bash
# 部署 PostgreSQL 和 Redis
kubectl apply -k k8s/base/db/

# 验证数据库状态
kubectl get pods -l app=postgres
kubectl get pods -l app=redis
kubectl get svc postgres-service
kubectl get svc redis-service
```

#### 阶段 3: Ingress NGINX 控制器
```bash
# 部署 Ingress NGINX
kubectl apply -k k8s/base/ingress-nginx/

# 等待控制器启动
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=ingress-nginx -n ingress-nginx --timeout=60s

# 验证控制器状态
kubectl get pods -n ingress-nginx
kubectl get svc -n ingress-nginx
```

#### 阶段 4: 应用程序
```bash
# 部署 ChatApp
kubectl apply -k k8s/base/app/

# 验证应用状态
kubectl get pods -l app=chatapp
kubectl get svc chatapp-service
kubectl get ingress chatapp-ingress
```

#### 阶段 5: Headlamp 管理界面
```bash
# 部署 Headlamp
kubectl apply -k k8s/base/headlamp/

# 验证 Headlamp 状态
kubectl get pods -l app=headlamp
kubectl get svc headlamp-service
kubectl get ingress headlamp-ingress
```

## 部署验证

### 检查所有组件状态
```bash
# 查看所有 Pod
kubectl get pods

# 查看所有服务
kubectl get svc

# 查看所有 Ingress
kubectl get ingress

# 查看所有命名空间
kubectl get namespaces
```

### 预期结果
```
NAME                        READY   STATUS    RESTARTS   AGE
chatapp-9497785dc-xxx       1/1     Running   0          Xm
chatapp-9497785dc-xxx       1/1     Running   0          Xm
chatapp-9497785dc-xxx       1/1     Running   0          Xm
headlamp-646d4b75cc-xxx     1/1     Running   0          Xm
postgres-0                  1/1     Running   0          Xm
redis-0                     1/1     Running   0          Xm

NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
chatapp-service    ClusterIP   10.xxx.xxx.xxx  <none>        80/TCP     Xm
headlamp-service   ClusterIP   10.xxx.xxx.xxx  <none>        80/TCP     Xm
postgres-service   ClusterIP   10.xxx.xxx.xxx  <none>        5432/TCP   Xm
redis-service      ClusterIP   10.xxx.xxx.xxx  <none>        6379/TCP   Xm

NAME               CLASS   HOSTS       ADDRESS          PORTS   AGE
chatapp-ingress    nginx   localhost   10.xxx.xxx.xxx   80      Xm
headlamp-ingress   nginx   localhost   10.xxx.xxx.xxx   80      Xm
```

## 访问验证

### 测试应用程序访问
```bash
# 测试 ChatApp
curl -I http://localhost:30080/app

# 测试 Headlamp
curl -I http://localhost:30080/headlamp

# 测试静态资源
curl -I http://localhost:30080/headlamp/assets/index-BxUqu7Ze.js
```

### 预期响应
- **ChatApp**: HTTP 200 OK
- **Headlamp**: HTTP 200 OK
- **静态资源**: HTTP 200 OK

## 访问地址

部署完成后，您可以通过以下地址访问各个服务：

### 主要服务
- **ChatApp 应用程序**: `http://localhost:30080/app`
- **Headlamp 管理界面**: `http://localhost:30080/headlamp`

### 端口转发访问（可选）
```bash
# ChatApp 端口转发
kubectl port-forward svc/chatapp-service 8080:80
# 访问: http://localhost:8080

# Headlamp 端口转发
kubectl port-forward svc/headlamp-service 8081:80
# 访问: http://localhost:8081
```

## 故障排除

### 常见问题及解决方案

#### 1. Pod 启动失败
```bash
# 查看 Pod 详情
kubectl describe pod <pod-name>

# 查看 Pod 日志
kubectl logs <pod-name>

# 查看事件
kubectl get events --sort-by=.metadata.creationTimestamp
```

#### 2. 服务无法访问
```bash
# 检查服务状态
kubectl get svc

# 检查 Ingress 状态
kubectl get ingress

# 检查 Ingress NGINX 控制器
kubectl get pods -n ingress-nginx
```

#### 3. 静态资源 404
```bash
# 检查 Ingress 配置
kubectl describe ingress headlamp-ingress

# 验证路径重写规则
kubectl get ingress headlamp-ingress -o yaml
```

#### 4. 数据库连接问题
```bash
# 检查数据库 Pod
kubectl get pods -l app=postgres
kubectl get pods -l app=redis

# 测试数据库连接
kubectl exec deployment/chatapp -- nslookup postgres-service
kubectl exec deployment/chatapp -- nslookup redis-service
```

## 清理部署

### 完全清理
```bash
# 删除所有资源
kubectl delete -k k8s/overlays/docker-desktop/

# 或分阶段清理
kubectl delete -k k8s/base/headlamp/
kubectl delete -k k8s/base/app/
kubectl delete -k k8s/base/ingress-nginx/
kubectl delete -k k8s/base/db/
kubectl delete -k k8s/base/secrets/
```

### 验证清理
```bash
# 确认所有资源已删除
kubectl get all
kubectl get ingress
kubectl get secrets
```

## 重新部署

### 更新配置后重新部署
```bash
# 重新应用配置
kubectl apply -k k8s/overlays/docker-desktop/

# 或强制重新创建
kubectl delete -k k8s/overlays/docker-desktop/
kubectl apply -k k8s/overlays/docker-desktop/
```

### 滚动更新
```bash
# 更新应用程序镜像
kubectl set image deployment/chatapp chatapp=ghcr.io/lowjungxuan98/chatapp-development:16

# 查看更新状态
kubectl rollout status deployment/chatapp

# 回滚更新
kubectl rollout undo deployment/chatapp
```

## 监控和维护

### 查看资源使用情况
```bash
# 查看 Pod 资源使用
kubectl top pods

# 查看节点资源使用
kubectl top nodes

# 查看服务状态
kubectl get svc -o wide
```

### 日志管理
```bash
# 查看应用程序日志
kubectl logs -l app=chatapp --tail=100

# 查看 Headlamp 日志
kubectl logs -l app=headlamp --tail=100

# 实时查看日志
kubectl logs -f deployment/chatapp
```

## 最佳实践

### 部署前检查
1. 确保 Docker Desktop 已启动
2. 验证 kubectl 配置正确
3. 检查集群资源充足
4. 确认网络连接正常

### 部署后验证
1. 检查所有 Pod 状态为 Running
2. 验证服务可正常访问
3. 测试应用程序功能
4. 确认静态资源加载正常

### 安全注意事项
1. 生产环境请修改默认密码
2. 限制 RBAC 权限范围
3. 启用网络策略
4. 定期更新镜像版本

## 总结

通过本指南，您可以成功部署完整的 Kubernetes 基础设施，包括：

- ✅ **Secret 管理**: 安全的环境变量配置
- ✅ **数据库服务**: PostgreSQL 和 Redis 持久化存储
- ✅ **Ingress 控制器**: NGINX 入口流量管理
- ✅ **应用程序**: ChatApp 多副本部署
- ✅ **管理界面**: Headlamp Kubernetes Web UI

所有组件都已测试验证，可以正常访问和使用。
