# Phase 3: Ingress NGINX 配置

## Ingress NGINX 控制器

**配置状态**: ✅ 已验证，配置语法正确，已修复弃用警告

### 配置概述
- **版本**: Ingress NGINX Controller v1.8.2
- **命名空间**: `ingress-nginx`
- **服务类型**: NodePort (适用于 Docker Desktop)
- **HTTP 端口**: 30080
- **HTTPS 端口**: 30443
- **配置方式**: 使用最新的 `patches` 语法（已修复弃用警告）

### 服务配置
```yaml
# Ingress NGINX 控制器服务
apiVersion: v1
kind: Service
metadata:
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  type: NodePort
  ports:
  - name: http
    port: 80
    targetPort: 80
    nodePort: 30080
  - name: https
    port: 443
    targetPort: 443
    nodePort: 30443
```

## 部署命令

### 基础部署
```bash
# 部署 Ingress NGINX 控制器
kubectl apply -k k8s/base/ingress-nginx/

# 查看控制器状态
kubectl get pods -n ingress-nginx
kubectl get svc -n ingress-nginx
```

### Docker Desktop 环境部署
```bash
# 使用 Docker Desktop overlay 部署
kubectl apply -k k8s/overlays/docker-desktop/

# 查看所有资源
kubectl get all -n ingress-nginx
```

### 配置验证
```bash
# 验证配置语法（无警告）
kubectl apply --dry-run=client -k k8s/base/ingress-nginx/

# 验证 Docker Desktop overlay
kubectl apply --dry-run=client -k k8s/overlays/docker-desktop/
```

## 验证安装

```bash
# 检查控制器是否运行
kubectl get pods -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx

# 检查服务状态
kubectl get svc ingress-nginx-controller -n ingress-nginx

# 查看控制器日志
kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
```

## 访问方式

### Docker Desktop
- **HTTP**: `http://localhost:30080`
- **HTTPS**: `https://localhost:30443`

### 其他 Kubernetes 环境
- **HTTP**: `http://<node-ip>:30080`
- **HTTPS**: `https://<node-ip>:30443`

## 测试 Ingress

创建一个测试 Ingress 资源：

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: test-ingress
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: localhost
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: your-app-service
            port:
              number: 80
```

## 常用命令

```bash
# 查看 Ingress 资源
kubectl get ingress

# 查看 Ingress 详情
kubectl describe ingress <ingress-name>

# 查看 Ingress 控制器配置
kubectl get configmap -n ingress-nginx

# 重启 Ingress 控制器
kubectl rollout restart deployment/ingress-nginx-controller -n ingress-nginx
```

## 故障排除

### 常见问题
1. **控制器未启动**: 检查节点资源是否充足
2. **服务无法访问**: 确认 NodePort 端口未被占用
3. **Ingress 不生效**: 检查 Ingress 资源配置和后端服务状态

### 调试命令
```bash
# 查看控制器事件
kubectl get events -n ingress-nginx

# 查看控制器配置
kubectl describe deployment ingress-nginx-controller -n ingress-nginx

# 测试后端服务连接
kubectl port-forward svc/your-app-service 8080:80
```
