# Kubernetes 单节点安装指南

## 一键安装

```bash
# 1. 配置防火墙
sudo ufw allow 22 && sudo ufw allow 6443 && sudo ufw allow 2379:2380/tcp && sudo ufw allow 10250:10252/tcp && sudo ufw --force enable

# 2. 安装组件
sudo apt-get update
sudo apt-get install -y --allow-change-held-packages kubelet kubeadm kubectl containerd
sudo apt-mark hold kubelet kubeadm kubectl
sudo systemctl enable --now kubelet containerd

# 3. 配置containerd
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml >/dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
sudo systemctl restart containerd

# 4. 启用IP转发
echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf && sudo sysctl -p

# 5. 初始化集群
sudo swapoff -a
sudo kubeadm init --pod-network-cidr=192.168.0.0/16

# 6. 配置kubectl
mkdir -p ~/.kube
sudo cp /etc/kubernetes/admin.conf ~/.kube/config
sudo chown $(id -u):$(id -g) ~/.kube/config

# 7. 安装网络
kubectl apply -f https://docs.tigera.io/calico/latest/manifests/calico.yaml
kubectl taint nodes --all node-role.kubernetes.io/control-plane- || true

# 8. 验证
kubectl get nodes
kubectl get pods -A
```

**✅ 完成！** 节点状态显示 `Ready` 即可。

## 测试
```bash
kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get services
```

## 问题
- 节点 `NotReady` → 等待网络插件启动
- 权限错误 → 重新执行kubectl配置命令
- IP转发错误 → `echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf && sudo sysctl -p`
- 重置集群 → `sudo kubeadm reset --force`
