# Phase 5: Headlamp Kubernetes 管理界面

## Headlamp 配置

**配置状态**: ✅ 已配置，Kubernetes 管理界面，提供 Web UI 管理功能

### Headlamp 信息
- **镜像**: `ghcr.io/headlamp-k8s/headlamp:v0.34.0`
- **应用名称**: `headlamp`
- **端口**: `4466`
- **服务名称**: `headlamp`
- **访问路径**: `/headlamp`
- **命名空间**: `default`

### 资源配置
- **副本数**: 1
- **内存请求**: 128Mi
- **内存限制**: 512Mi
- **CPU 请求**: 100m
- **CPU 限制**: 500m

## RBAC 权限配置

### ServiceAccount
- **名称**: `headlamp-admin`
- **命名空间**: `default`

### ClusterRole 权限
Headlamp 使用 `cluster-admin` ClusterRole，具有集群的完全访问权限：
- 所有 API Groups 的完全访问权限
- 集群级别的资源管理权限
- 跨命名空间的资源访问权限

### 认证令牌
- **Secret 名称**: `headlamp-admin-token`
- **类型**: `kubernetes.io/service-account-token`
- **用途**: 用于 Headlamp Web UI 登录认证

## 部署命令

### 单独部署 Headlamp
```bash
# 部署 Headlamp
kubectl apply -k k8s/base/headlamp/

# 查看 Headlamp 状态
kubectl -n default get pods -l app.kubernetes.io/name=headlamp
kubectl -n default get svc headlamp
kubectl -n default get ingress headlamp
```

### 完整部署（包含 Headlamp）
```bash
# 使用 Docker Desktop overlay 部署所有组件
kubectl apply -k k8s/overlays/docker-desktop/

# 查看所有资源
kubectl -n default get all -l app.kubernetes.io/name=headlamp
```

## 配置验证

```bash
# 验证 Headlamp 配置
kubectl apply --dry-run=client -k k8s/base/headlamp/

# 验证 RBAC 配置
kubectl -n default get serviceaccount headlamp-admin
kubectl get clusterrolebinding headlamp-admin
kubectl -n default get secret headlamp-admin-token
```

## 访问 Headlamp

### 通过 Ingress 访问
- **URL**: `http://localhost:30080/headlamp/`
- **路径**: `/headlamp`
- **协议**: HTTP
- **端口**: 30080 (通过 Ingress-NGINX NodePort)

### 获取登录令牌
```bash
# 获取 ServiceAccount 令牌用于登录
kubectl -n default get secret headlamp-admin-token -o go-template='{{.data.token | base64decode}}'
```

### 登录步骤
1. 访问 `http://localhost:30080/headlamp/`
2. 选择 "Token" 登录方式
3. 将获取的令牌粘贴到登录页面
4. 点击登录

### 端口转发访问（调试用）
```bash
# 直接访问 Headlamp 服务
kubectl -n default port-forward svc/headlamp 8080:80

# 访问: http://localhost:8080/headlamp/
```

## 功能特性

### 集群管理
- 查看和管理 Pod、Service、Deployment 等资源
- 实时监控集群状态
- 查看资源使用情况

### 日志查看
- 查看 Pod 日志
- 实时日志流
- 日志搜索和过滤

### 资源操作
- 创建、编辑、删除资源
- 扩缩容 Deployment
- 查看事件和状态

### 集群级访问
- 具有 `cluster-admin` 权限，可访问所有命名空间
- 支持跨命名空间的资源管理
- 完整的集群监控和管理功能

## 健康检查

### 探针配置
- **就绪探针**: HTTP GET `/headlamp/` 端口 4466，初始延迟 10 秒，周期 10 秒
- **存活探针**: HTTP GET `/headlamp/` 端口 4466，初始延迟 30 秒，周期 20 秒

### 检查 Headlamp 状态
```bash
# 查看 Pod 状态
kubectl -n default get pods -l app.kubernetes.io/name=headlamp

# 查看 Pod 详情
kubectl -n default describe pod -l app.kubernetes.io/name=headlamp

# 查看 Headlamp 日志
kubectl -n default logs deploy/headlamp

# 查看事件
kubectl -n default get events --sort-by=.metadata.creationTimestamp
```

## 故障排除

### 常见问题
1. **Pod 启动失败**: 检查镜像拉取和 RBAC 配置
2. **无法访问**: 检查 Ingress 和服务配置
3. **权限不足**: 验证 ClusterRoleBinding 和 ServiceAccount
4. **404 错误**: 检查 Ingress 路径配置，确保路径为 `/headlamp`

### 调试命令
```bash
# 查看 Headlamp 日志
kubectl -n default logs deploy/headlamp --tail=100

# 进入 Pod 调试
kubectl -n default exec -it deployment/headlamp -- /bin/sh

# 检查 RBAC 权限
kubectl auth can-i --list --as=system:serviceaccount:default:headlamp-admin

# 测试服务连接
kubectl -n default port-forward svc/headlamp 8080:80

# 检查 Ingress 状态
kubectl -n default describe ingress headlamp
```

## 安全注意事项

### 权限管理
- Headlamp 具有集群管理员权限
- 仅用于开发和测试环境
- 生产环境建议限制权限范围

### 访问控制
- 通过 Ingress 访问，可配置认证
- 建议在生产环境中添加身份验证
- 定期审查 RBAC 权限配置

## 扩展和更新

### 更新 Headlamp
```bash
# 更新到最新版本
kubectl -n default set image deployment/headlamp headlamp=ghcr.io/headlamp-k8s/headlamp:latest

# 查看更新状态
kubectl -n default rollout status deployment/headlamp

# 回滚更新
kubectl -n default rollout undo deployment/headlamp
```

### 重新部署配置
```bash
# 重新应用所有配置
kubectl apply -k k8s/base/headlamp/

# 重启 Deployment
kubectl -n default rollout restart deployment/headlamp
```

### 清理资源
```bash
# 删除所有 Headlamp 资源
kubectl delete -k k8s/base/headlamp/
```
