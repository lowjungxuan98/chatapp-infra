# Phase 5: Headlamp Kubernetes 管理界面

## Headlamp 配置

**配置状态**: ✅ 已配置，Kubernetes 管理界面，提供 Web UI 管理功能

### Headlamp 信息
- **镜像**: `ghcr.io/headlamp-k8s/headlamp:latest`
- **应用名称**: `headlamp`
- **端口**: `4466`
- **服务名称**: `headlamp-service`
- **访问路径**: `/headlamp`

### 资源配置
- **副本数**: 1
- **内存请求**: 128Mi
- **内存限制**: 256Mi
- **CPU 请求**: 100m
- **CPU 限制**: 200m

## RBAC 权限配置

### ServiceAccount
- **名称**: `headlamp`
- **命名空间**: `default`

### ClusterRole 权限
Headlamp 具有以下 Kubernetes 资源的完全访问权限：
- 核心资源 (`""` API Group)
- 应用程序资源 (`apps` API Group)
- 扩展资源 (`extensions` API Group)
- 网络资源 (`networking.k8s.io` API Group)
- RBAC 资源 (`rbac.authorization.k8s.io` API Group)

### 环境配置
- `HEADLAMP_CONFIG_NAMESPACES`: `default,ingress-nginx`
- `HEADLAMP_CONFIG_LOGS`: `true`

## 部署命令

### 单独部署 Headlamp
```bash
# 部署 Headlamp
kubectl apply -k k8s/base/headlamp/

# 查看 Headlamp 状态
kubectl get pods -l app=headlamp
kubectl get svc headlamp-service
kubectl get ingress headlamp-ingress
```

### 完整部署（包含 Headlamp）
```bash
# 使用 Docker Desktop overlay 部署所有组件
kubectl apply -k k8s/overlays/docker-desktop/

# 查看所有资源
kubectl get all -l app=headlamp
```

## 配置验证

```bash
# 验证 Headlamp 配置
kubectl apply --dry-run=client -k k8s/base/headlamp/

# 验证 RBAC 配置
kubectl get serviceaccount headlamp
kubectl get clusterrole headlamp
kubectl get clusterrolebinding headlamp
```

## 访问 Headlamp

### 通过 Ingress 访问
- **URL**: `http://localhost:30080/headlamp`
- **路径**: `/headlamp`
- **静态资源**: 支持所有静态资源路径（CSS、JS、manifest.json 等）

### 端口转发访问
```bash
# 直接访问 Headlamp 服务
kubectl port-forward svc/headlamp-service 8080:80

# 访问: http://localhost:8080
```

## 功能特性

### 集群管理
- 查看和管理 Pod、Service、Deployment 等资源
- 实时监控集群状态
- 查看资源使用情况

### 日志查看
- 查看 Pod 日志
- 实时日志流
- 日志搜索和过滤

### 资源操作
- 创建、编辑、删除资源
- 扩缩容 Deployment
- 查看事件和状态

### 多命名空间支持
- 默认访问 `default` 和 `ingress-nginx` 命名空间
- 可配置访问其他命名空间

## 健康检查

### 探针配置
- **就绪探针**: HTTP GET `/` 端口 4466，初始延迟 5 秒
- **存活探针**: HTTP GET `/` 端口 4466，初始延迟 30 秒

### 检查 Headlamp 状态
```bash
# 查看 Pod 状态
kubectl get pods -l app=headlamp

# 查看 Pod 详情
kubectl describe pod -l app=headlamp

# 查看 Headlamp 日志
kubectl logs -l app=headlamp

# 查看事件
kubectl get events --sort-by=.metadata.creationTimestamp
```

## 故障排除

### 常见问题
1. **Pod 启动失败**: 检查镜像拉取和 RBAC 配置
2. **无法访问**: 检查 Ingress 和服务配置
3. **权限不足**: 验证 ClusterRole 和 ClusterRoleBinding
4. **静态资源 404**: 检查 Ingress 路径重写规则，确保支持正则表达式路径匹配

### 调试命令
```bash
# 查看 Headlamp 日志
kubectl logs -l app=headlamp --tail=100

# 进入 Pod 调试
kubectl exec -it deployment/headlamp -- /bin/sh

# 检查 RBAC 权限
kubectl auth can-i --list --as=system:serviceaccount:default:headlamp

# 测试服务连接
kubectl port-forward svc/headlamp-service 8080:80
```

## 安全注意事项

### 权限管理
- Headlamp 具有集群管理员权限
- 仅用于开发和测试环境
- 生产环境建议限制权限范围

### 访问控制
- 通过 Ingress 访问，可配置认证
- 建议在生产环境中添加身份验证
- 定期审查 RBAC 权限配置

## 扩展和更新

### 更新 Headlamp
```bash
# 更新到最新版本
kubectl set image deployment/headlamp headlamp=ghcr.io/headlamp-k8s/headlamp:latest

# 查看更新状态
kubectl rollout status deployment/headlamp

# 回滚更新
kubectl rollout undo deployment/headlamp
```

### 配置自定义命名空间
```bash
# 编辑 Deployment 添加更多命名空间
kubectl edit deployment headlamp

# 修改环境变量
# HEADLAMP_CONFIG_NAMESPACES: "default,ingress-nginx,kube-system"
```
