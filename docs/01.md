# Phase 1: Secret 配置

## Secret 配置方式
项目使用标准的 Kubernetes Secret 资源定义，所有敏感数据都使用 Base64 编码存储在 `k8s/base/secrets/secret.yaml` 文件中。

**配置状态**: ✅ 已验证，配置语法正确，无警告，已成功部署到集群

## 已配置的环境变量
项目已配置以下环境变量到 Kubernetes Secret：

### 数据库配置
- `POSTGRES_PRISMA_URL`: PostgreSQL 连接字符串（带连接超时）- `postgresql://postgres:postgres@postgres-service:5432/chatapp?connect_timeout=15`
- `POSTGRES_URL_NON_POOLING`: PostgreSQL 非池化连接字符串 - `postgresql://postgres:postgres@postgres-service:5432/chatapp`
- `REDIS_URL`: Redis 连接字符串 - `redis://redis-service:6379`

### 认证配置
- `AUTH_SECRET`: 认证密钥
- `AUTH_TRUST_HOST`: 信任主机设置
- `NEXTAUTH_URL`: NextAuth 回调 URL

### 邮件配置
- `SMTP_HOST`: SMTP 服务器地址
- `SMTP_PORT`: SMTP 端口
- `SMTP_USERNAME`: SMTP 用户名
- `SMTP_PASSWORD`: SMTP 密码
- `EMAIL_FROM`: 发件人邮箱

## 部署命令
```bash
# 部署 Secret 到集群
kubectl apply -k k8s/base/secrets/

# 或使用 Docker Desktop overlay 部署（推荐）
kubectl apply -k k8s/overlays/docker-desktop/

# 查看 Secret
kubectl get secrets

# 查看 Secret 详情
kubectl describe secret app-secrets

# 查看 Secret 内容（Base64 编码）
kubectl get secret app-secrets -o yaml
```

## 配置验证
```bash
# 验证 Secret 配置语法
kubectl apply --dry-run=client -k k8s/base/secrets/

# 验证 Secret 内容
kubectl get secret app-secrets -o yaml | grep -A 20 "data:"
```

## 在应用中使用 Secret

### 当前应用配置
应用程序已配置为自动注入所有 Secret 环境变量：

```yaml
# 在 deployment.yaml 中的配置
envFrom:
  - secretRef:
      name: app-secrets
```

### 其他使用方式
```yaml
# 方式1: 全部环境变量（当前使用）
envFrom:
  - secretRef:
      name: app-secrets

# 方式2: 单个环境变量
env:
  - name: POSTGRES_PRISMA_URL
    valueFrom:
      secretKeyRef:
        name: app-secrets
        key: POSTGRES_PRISMA_URL
```

## Secret 管理

### 查看 Secret 内容
```bash
# 查看所有 Secret
kubectl get secrets

# 查看特定 Secret 的详细信息
kubectl describe secret app-secrets

# 查看 Secret 的原始内容（Base64 编码）
kubectl get secret app-secrets -o yaml

# 解码特定环境变量
echo "cG9zdGdyZXNxbDovL3Bvc3RncmVzOnBvc3RncmVzQHBvc3RncmVzLXNlcnZpY2U6NTQzMi9jaGF0YXBw" | base64 -d
```

### 更新 Secret
```bash
# 方法1: 直接编辑 Secret 文件
kubectl edit secret app-secrets

# 方法2: 重新应用配置
kubectl apply -k k8s/base/secrets/

# 方法3: 删除并重新创建
kubectl delete secret app-secrets
kubectl apply -k k8s/base/secrets/
```

### 安全注意事项
- Secret 数据使用 Base64 编码，不是加密
- 在生产环境中建议使用外部 Secret 管理系统
- 避免在日志中暴露 Secret 内容
- 定期轮换敏感凭据

## 部署状态验证

### 检查 Secret 部署状态
```bash
# 查看 Secret 是否存在
kubectl get secret app-secrets

# 验证 Secret 内容
kubectl describe secret app-secrets

# 检查应用程序是否正确使用 Secret
kubectl get pods -l app=chatapp
kubectl describe pod -l app=chatapp
```

### 验证环境变量注入
```bash
# 检查应用程序中的环境变量
kubectl exec deployment/chatapp -- env | grep -E "(POSTGRES|REDIS|AUTH|SMTP)"

# 验证数据库连接
kubectl exec deployment/chatapp -- nslookup postgres-service
kubectl exec deployment/chatapp -- nslookup redis-service
```

### 当前部署状态
- ✅ Secret 已成功部署到集群
- ✅ 应用程序正在使用 Secret 中的环境变量
- ✅ 数据库连接配置正确
- ✅ 所有环境变量已注入到应用程序中
