# Phase 4: 应用程序部署

## 应用程序配置

**配置状态**: ✅ 已验证，应用程序配置语法正确，Secret 集成正常

### 应用信息
- **镜像**: `ghcr.io/lowjungxuan98/chatapp-development:15`
- **应用名称**: `chatapp`
- **端口**: `3000`
- **服务名称**: `chatapp-service`
- **Ingress 主机**: `localhost`

### 资源配置
- **副本数**: 3
- **内存请求**: 256Mi
- **内存限制**: 512Mi
- **CPU 请求**: 250m
- **CPU 限制**: 500m

## Secret 集成

### 环境变量注入
应用程序通过 `envFrom` 自动注入所有 Secret 环境变量：

```yaml
envFrom:
- secretRef:
    name: app-secrets
```

### 可用的环境变量
- `POSTGRES_PRISMA_URL`: PostgreSQL 连接字符串
- `POSTGRES_URL_NON_POOLING`: PostgreSQL 非池化连接
- `REDIS_URL`: Redis 连接字符串
- `AUTH_SECRET`: 认证密钥
- `AUTH_TRUST_HOST`: 信任主机设置
- `NEXTAUTH_URL`: NextAuth 回调 URL
- `SMTP_HOST`: SMTP 服务器
- `SMTP_PORT`: SMTP 端口
- `SMTP_USERNAME`: SMTP 用户名
- `SMTP_PASSWORD`: SMTP 密码
- `EMAIL_FROM`: 发件人邮箱

## 部署命令

### 完整部署流程
```bash
# 1. 部署 Secret
kubectl apply -k k8s/base/secrets/

# 2. 部署数据库
kubectl apply -k k8s/base/db/

# 3. 部署 Ingress NGINX
kubectl apply -k k8s/base/ingress-nginx/

# 4. 部署应用程序
kubectl apply -k k8s/base/app/

# 5. 或使用 Docker Desktop overlay 一次性部署
kubectl apply -k k8s/overlays/docker-desktop/
```

### 单独部署应用程序
```bash
# 部署应用程序
kubectl apply -k k8s/base/app/

# 查看部署状态
kubectl get pods -l app=chatapp
kubectl get svc chatapp-service
kubectl get ingress chatapp-ingress
```

## 配置验证

```bash
# 验证应用程序配置
kubectl apply --dry-run=client -k k8s/base/app/

# 验证 Secret 集成
kubectl get secret app-secrets -o yaml

# 查看 Secret 详情
kubectl describe secret app-secrets
```

## 健康检查

### 探针配置
- **就绪探针**: HTTP GET `/` 端口 3000，初始延迟 5 秒
- **存活探针**: HTTP GET `/` 端口 3000，初始延迟 30 秒

### 检查应用状态
```bash
# 查看 Pod 状态
kubectl get pods -l app=chatapp

# 查看 Pod 详情
kubectl describe pod -l app=chatapp

# 查看应用日志
kubectl logs -l app=chatapp

# 查看事件
kubectl get events --sort-by=.metadata.creationTimestamp
```

## 访问应用

### 通过 Ingress 访问
- **URL**: `http://localhost:30080/app`
- **路径**: `/app`

### 端口转发访问
```bash
# 直接访问应用服务
kubectl port-forward svc/chatapp-service 8080:80

# 访问: http://localhost:8080
```

## 故障排除

### 常见问题
1. **Pod 启动失败**: 检查镜像拉取和 Secret 配置
2. **健康检查失败**: 确认应用在端口 3000 上响应
3. **无法访问**: 检查 Ingress 和服务配置

### 调试命令
```bash
# 查看 Pod 日志
kubectl logs -l app=chatapp --tail=100

# 进入 Pod 调试
kubectl exec -it deployment/chatapp -- /bin/sh

# 检查环境变量
kubectl exec deployment/chatapp -- env | grep -E "(POSTGRES|REDIS|AUTH|SMTP)"

# 测试数据库连接
kubectl exec deployment/chatapp -- nslookup postgres-service
kubectl exec deployment/chatapp -- nslookup redis-service
```

## 扩展和更新

### 扩展应用
```bash
# 当前副本数已设置为 3
# 如需调整副本数
kubectl scale deployment chatapp --replicas=5

# 查看扩展状态
kubectl get pods -l app=chatapp

# 查看副本集状态
kubectl get replicaset -l app=chatapp
```

### 更新应用
```bash
# 更新镜像版本
kubectl set image deployment/chatapp chatapp=ghcr.io/lowjungxuan98/chatapp-development:16

# 查看更新状态
kubectl rollout status deployment/chatapp

# 回滚更新
kubectl rollout undo deployment/chatapp
```
