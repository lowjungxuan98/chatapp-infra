# Phase 2: PostgreSQL 和 Redis 配置

## 数据库服务配置

**配置状态**: ✅ 已验证，PostgreSQL 和 Redis 配置语法正确，无警告，已成功部署到集群

### PostgreSQL 配置
- **服务名称**: `postgres-service`
- **端口**: `5432`
- **数据库**: `chatapp`
- **用户**: `postgres`
- **密码**: `postgres`
- **存储**: 10Gi 持久化存储

### Redis 配置
- **服务名称**: `redis-service`
- **端口**: `6379`
- **持久化**: 启用 AOF (Append Only File)
- **存储**: 5Gi 持久化存储

## 更新的数据库连接 URL

### PostgreSQL 连接字符串
```
POSTGRES_PRISMA_URL=postgresql://postgres:postgres@postgres-service:5432/chatapp?connect_timeout=15
POSTGRES_URL_NON_POOLING=postgresql://postgres:postgres@postgres-service:5432/chatapp
```

### Redis 连接字符串
```
REDIS_URL=redis://redis-service:6379
```

## 部署命令

```bash
# 部署数据库服务（使用聚合配置）
kubectl apply -k k8s/base/db/

# 或使用 Docker Desktop overlay 部署（推荐）
kubectl apply -k k8s/overlays/docker-desktop/

# 查看 PostgreSQL 服务状态
kubectl get pods -l app=postgres
kubectl get svc postgres-service

# 查看 Redis 服务状态
kubectl get pods -l app=redis
kubectl get svc redis-service

# 查看所有数据库相关资源
kubectl get all -l app=postgres
kubectl get all -l app=redis
```

## 配置验证

```bash
# 验证整个数据库配置（推荐）
kubectl apply --dry-run=client -k k8s/base/db/

# 验证 PostgreSQL 配置
kubectl apply --dry-run=client -k k8s/base/db/postgres/

# 验证 Redis 配置
kubectl apply --dry-run=client -k k8s/base/db/redis/
```

## 数据库连接测试

```bash
# 测试 PostgreSQL 连接
kubectl run postgres-client --rm -it --restart=Never --image=postgres:15 -- psql -h postgres-service -U postgres -d chatapp

# 测试 Redis 连接
kubectl run redis-client --rm -it --restart=Never --image=redis:7-alpine -- redis-cli -h redis-service
```

## 数据持久化

两个数据库都配置了持久化存储：
- PostgreSQL 数据存储在 `/var/lib/postgresql/data`
- Redis 数据存储在 `/data`
- 使用 StatefulSet 确保数据持久性和有序部署

## 部署状态验证

### 检查数据库部署状态
```bash
# 查看数据库 Pod 状态
kubectl get pods -l app=postgres
kubectl get pods -l app=redis

# 查看数据库服务状态
kubectl get svc postgres-service
kubectl get svc redis-service

# 查看 StatefulSet 状态
kubectl get statefulset postgres
kubectl get statefulset redis
```

### 验证数据库连接
```bash
# 检查应用程序是否能连接到数据库
kubectl exec deployment/chatapp -- nslookup postgres-service
kubectl exec deployment/chatapp -- nslookup redis-service

# 测试数据库连接
kubectl run postgres-client --rm -it --restart=Never --image=postgres:15 -- psql -h postgres-service -U postgres -d chatapp
kubectl run redis-client --rm -it --restart=Never --image=redis:7-alpine -- redis-cli -h redis-service
```

### 当前部署状态
- ✅ PostgreSQL StatefulSet 已成功部署并运行
- ✅ Redis StatefulSet 已成功部署并运行
- ✅ 数据库服务已创建并可访问
- ✅ 持久化存储已配置
- ✅ 应用程序可正常连接数据库
