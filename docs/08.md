# TLS 证书配置指南

## 1. 检查清单

### 配置文件已修改
- [x] `k8s/base/kustomization.yaml` - 添加 cert-manager 资源
- [x] `k8s/base/cert-manager/kustomization.yaml` - cert-manager 配置
- [x] `k8s/base/cert-manager/cluster-issuer.yaml` - Let's Encrypt 证书颁发者
- [x] `k8s/base/app/ingress.yaml` - 应用 Ingress TLS 配置
- [x] `k8s/base/headlamp/ingress.yaml` - 管理界面 Ingress TLS 配置

### 网络要求
- [ ] 域名 `lowjungxuan.duckdns.org` 解析到 `104.248.152.166`
- [ ] 防火墙开放 80 和 443 端口

## 2. 如何部署

```bash
# 步骤 1: 部署 cert-manager (包含 CRDs)
kubectl apply -k k8s/base/cert-manager/

# 步骤 2: 等待 cert-manager 就绪
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=cert-manager -n cert-manager --timeout=300s

# 步骤 3: 验证 ClusterIssuer 已创建
kubectl get clusterissuer letsencrypt-prod

# 步骤 4: 部署更新后的应用配置
kubectl apply -k k8s/overlays/docker-desktop/
```

## 3. 如何验证

```bash
# 检查 cert-manager 状态
kubectl get pods -n cert-manager
kubectl get clusterissuer letsencrypt-prod

# 检查证书状态
kubectl get certificates -A

# 检查 Ingress 状态
kubectl get ingress -A

# 测试 HTTPS 访问
curl -I https://lowjungxuan.duckdns.org/
curl -I https://lowjungxuan.duckdns.org/headlamp
```

## 访问地址

- **聊天应用**: https://lowjungxuan.duckdns.org/
- **管理界面**: https://lowjungxuan.duckdns.org/headlamp

## 故障排除

```bash
# 检查 cert-manager 日志
kubectl logs -n cert-manager -l app.kubernetes.io/name=cert-manager

# 检查证书详情
kubectl describe certificate chatapp-tls -n default
kubectl describe certificate headlamp-tls -n default
```
